services:
  api:
    image: ${APPNAME}-${ENV}-api-img
    container_name: ${APPNAME}-${ENV}-api-svc
    build:
      context: .
      dockerfile: dockerfile.api
      args:
        APPNAME: ${APPNAME}
        PORT: ${API_PORT}
    env_file:
      - api/env/.env.${ENV}   
    networks:
      - ${APPNAME}-network  
    ports:
      - "${API_PORT}:${API_PORT}"
    secrets:
      - db_password   
      - via_auth
    depends_on:
      - db  

  web:
    build:
      context: .
      dockerfile: dockerfile.web
      args:
        ENV: ${ENV}
        PORT: ${WEB_PORT}
    environment:
      PORT: ${WEB_PORT} 
    image: ${APPNAME}-${ENV}-web-img
    container_name: ${APPNAME}-${ENV}-web-svc
    ports:
      - "${WEB_PORT}:80"
    networks:
      - via-network  
    depends_on:
      - api

  db:
    image: postgres:15
    container_name: ${APPNAME}-${ENV}-db
    env_file:
      - db/env/.env.${ENV}  
    volumes:
      - ./db_data.${ENV}:/var/lib/postgresql/data 
      - ./db/conf/pg_hba.conf:/etc/postgresql/pg_hba.conf:ro
      - ./db/script/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    command: >
      -c hba_file=/etc/postgresql/pg_hba.conf  
    networks:
      - ${APPNAME}-network
    secrets:
      - db_password
    ports:
      - "5432:5432"  # opcional si necesitas acceder desde el host

networks:
  via-network:
    name: ${APPNAME}-${ENV}-net
    driver: bridge

secrets:
  db_password:
    file: ./secrets/db_password.${ENV}
  via_auth:
    file: ./secrets/via_auth.${ENV}
